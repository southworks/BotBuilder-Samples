name: ci-dotnet-samples

env:
  ROOT_FOLDER: BotBuilder-Samples/samples/

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - "samples/**/*.cs"

jobs:
  generate:
    name: detect and generate bot matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v3

      - name: git diff
        uses: technote-space/get-diff-action@v4
        with:
          PATTERNS: samples/**/*.cs
          ABSOLUTE: true

      - name: generate matrix
        id: set-matrix
        shell: pwsh
        if: env.GIT_DIFF
        run: |
          function UpSearchFolder {
            param ([String] $path, [String] $file)

            while ($path -and !(Test-Path (Join-Path $path $file))) {
              $path = Split-Path $path -Parent
            }

            return $path
          }

          $paths = @("${{ env.GIT_DIFF_FILTERED }}" -replace "'", "" -split " ")
          $rootFolder = "${{ env.ROOT_FOLDER }}"
          $pkg = "appsettings.json"

          $result = $paths | ForEach-Object { UpSearchFolder -path $_ -file $pkg } | Get-Unique | ForEach-Object {
            $folder = $_
            $files = @($paths | Where-Object { $_.StartsWith($folder) })
            $csproj = Get-ChildItem -Path $folder -Filter *.csproj | Select-Object -ExpandProperty FullName -First 1
            return @{ 
              name = $folder.Substring($folder.IndexOf($rootFolder) + $rootFolder.Length);
              folder = $folder;
              files = $files;
              project = $csproj;
            } 
          }

          "Generated matrix:"
          ConvertTo-Json @($result)

          $matrix = ConvertTo-Json -Compress @($result)

          echo "::set-output name=matrix::$($matrix)"

  build:
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        include: ${{fromJSON(needs.generate.outputs.matrix)}}
      fail-fast: false

    name: bot - ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v3
      # - uses: xt0rted/dotnet-format-problem-matcher@v1

      - name: use .net 6.0.x
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "6.0.x"

      - name: dotnet format
        run: dotnet tool install -g dotnet-format

      - name: dotnet format
        run: dotnet-format ${{ matrix.project }} --include "${{ join(matrix.files, ' ') }}"
        working-directory: ${{ matrix.folder }}
